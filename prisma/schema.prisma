generator client {
  provider = "prisma-client"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String          @id @default(cuid())
  name          String?
  email         String          @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  simulationRuns SimulationRun[]
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime
 
  @@id([identifier, token])
}

model Symbol {
  id                   String   @id @default(cuid())
  name                 String
  type                 SymbolType
  baseStability        Float    // 0-100
  baseCollapsePressure Float
  description          String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations for fusion events where this symbol was a parent or result
  fusionEventsAsParentA FusionEvent[] @relation("ParentA")
  fusionEventsAsParentB FusionEvent[] @relation("ParentB")
  fusionEventsAsResult  FusionEvent[] @relation("ResultSymbol")
}

enum SymbolType {
  CONCEPT
  ENTITY
  RELATION
}

model SimulationRun {
  id        String   @id @default(cuid())
  name      String
  status    String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  settings  Json     // Stores simulation parameters (e.g., SCM variables)
  
  // Encrypted results
  encryptedResults String? 
  resultsIv        String? // Initialization vector for decryption
  
  // Legacy/Unencrypted results (optional, for backward compatibility or non-sensitive data)
  results   Json?    

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  timeSteps    TimeStep[]
  fusionEvents FusionEvent[]
}

enum SimulationStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model TimeStep {
  id              String   @id @default(cuid())
  simulationRunId String
  simulationRun   SimulationRun @relation(fields: [simulationRunId], references: [id])
  
  tick            Int
  stabilityIndex  Float
  collapseRisk    Float
  fusionPotential Float
  evolutionState  EvolutionState
  
  createdAt       DateTime @default(now())

  @@index([simulationRunId, tick])
}

enum EvolutionState {
  STABLE
  COLLAPSING
  FUSING
  EVOLVING
}

model FusionEvent {
  id              String   @id @default(cuid())
  simulationRunId String
  simulationRun   SimulationRun @relation(fields: [simulationRunId], references: [id])
  
  tick            Int
  
  parentSymbolAId String
  parentSymbolA   Symbol @relation("ParentA", fields: [parentSymbolAId], references: [id])
  
  parentSymbolBId String
  parentSymbolB   Symbol @relation("ParentB", fields: [parentSymbolBId], references: [id])
  
  resultingSymbolId String?
  resultingSymbol   Symbol? @relation("ResultSymbol", fields: [resultingSymbolId], references: [id])
  
  fusionCoefficient Float
  energyReleased    Float
  
  createdAt         DateTime @default(now())
}
